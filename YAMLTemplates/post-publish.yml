parameters:
- name: buildNumber
  type: string
- name: extensionName
  type: string
- name: mastodonUrl
  type: string
- name: mastodonKey
  type: string
- name: twitterUrl
  type: string 

steps:  
- task: richardfennellBM.BM-VSTS-BuildUpdating-Tasks-DEV.BuildVariableTask-Task.BuildVariableTask@1
  displayName: 'Update Build Variable'
  inputs:
    variable: Minor
    mode: Autoincrement
    usedefaultcreds: false

- task: richardfennellBM.BM-VSTS-ArtifactDescription-Tasks-DEV.ArtifactDescriptionTask.ArtifactDescriptionTask@1
  displayName: 'Get Git Artifact PR Reason'
  inputs:
    OutputText: 'OutputedText'

- pwsh: |
   # Write your PowerShell commands here.
   
   $uri = "${{parameters.twitterUrl}}" 
   $body = '{ "Tweet": "I have just released Version ${{parameters.buildNumber}} of my Azure DevOps Pipeline ${{parameters.extensionName}} http://bit.ly/VSTS-RF $(OutputedText) "}'
   
   Invoke-WebRequest -Uri $uri -Method POST -Body $body -Headers $headers -ContentType "application/json"
  displayName: 'Send Tweet about new release'

- powershell: |
    Write-Host "Posting to Mastodon"
    Invoke-WebRequest -Uri ${{parameters.mastodonUrl}}/api/v1/statuses -Method POST -Headers @{Authorization='Bearer ${{parameters.mastodonKey}}'}  -Body @{status='I have just released Version ${{parameters.buildNumber}} of my Azure DevOps Pipeline ${{parameters.extensionName}} http://bit.ly/VSTS-RF $(OutputedText)'}
  displayName: 'Posting to Mastodon about new release'
